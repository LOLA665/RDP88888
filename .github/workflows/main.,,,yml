name: ğŸš€ Windows Server 2025 QEMU RDP with Tailscale

on:
  workflow_dispatch:
    inputs:
      tailscale_auth_key:
        description: 'ğŸ”‘ Tailscale Auth Key (obÈ›ine de la https://login.tailscale.com/admin/settings/keys)'
        required: true
        type: string
      run_duration:
        description: 'â° Durata rulÄƒrii Ã®n zile (maxim 30)'
        required: false
        default: '30'
        type: choice
        options:
        - '1'
        - '7'
        - '30'

env:
  VM_NAME: "win2025-qemu"
  VM_RAM: "32G"
  VM_DISK: "30G"
  VM_CPU_CORES: 8

jobs:
  deploy-windows-vm:
    runs-on: ubuntu-latest
    timeout-minutes: 180
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4

    - name: ğŸ”§ Setup QEMU and dependencies
      run: |
        chmod +x scripts/setup-qemu.sh
        ./scripts/setup-qemu.sh

    - name: ğŸŒ Download Windows Server 2025 Evaluation
      run: |
        echo "ğŸ“¥ DescÄƒrcare Windows Server 2025..."
        wget -O win2025.iso "https://software-download.microsoft.com/download/pr/Windows_Server_2025_Preview_eval_x64fre_en-us.iso" ||
        wget -O win2025.iso "https://archive.org/download/windows-server-2025-preview/Windows_Server_2025_Preview_eval_x64fre_en-us.iso"
        
        # VerificÄƒ dacÄƒ ISO-ul a fost descÄƒrcat
        if [ ! -f win2025.iso ]; then
          echo "âŒ Nu s-a putut descÄƒrca ISO-ul. Folosim un ISO alternativ..."
          # CreazÄƒ un ISO minimal pentru testare
          mkdir -p iso_content
          echo "Windows Server 2025 Evaluation" > iso_content/README.txt
          genisoimage -o win2025.iso iso_content/
        fi

    - name: ğŸ’¾ Create virtual disk
      run: |
        echo "ğŸ’¾ Creare disk virtual de ${{ env.VM_DISK }}..."
        qemu-img create -f qcow2 windows2025.qcow2 ${{ env.VM_DISK }}

    - name: ğŸ” Generate secure password
      id: generate_password
      run: |
        PASSWORD=$(openssl rand -base64 16 | tr -d '/+' | cut -c1-16)
        echo "password=$PASSWORD" >> $GITHUB_OUTPUT
        echo "ğŸ” Parola generatÄƒ: $PASSWORD"

    - name: ğŸš€ Start QEMU VM installation
      run: |
        echo "ğŸš€ Pornire VM QEMU..."
        nohup qemu-system-x86_64 \
          -m ${{ env.VM_RAM }} \
          -smp ${{ env.VM_CPU_CORES }} \
          -cpu EPYC-Rome,vendor=AuthenticAMD \
          -machine type=pc,accel=tcg \
          -drive file=windows2025.qcow2,if=virtio,format=qcow2 \
          -cdrom win2025.iso \
          -boot order=dc \
          -netdev user,id=net0,hostfwd=tcp::3389-:3389,hostfwd=tcp::2222-:22 \
          -device virtio-net-pci,netdev=net0 \
          -vnc :0 -k en-us \
          -usb -device usb-tablet \
          -rtc base=localtime \
          -daemonize
        
        echo "â³ AÈ™teptare pornire VM..."
        sleep 30

    - name: ğŸ“Š Monitor VM status
      run: |
        echo "ğŸ“Š Verificare status VM..."
        ps aux | grep qemu-system-x86_64 || echo "âš ï¸ QEMU nu ruleazÄƒ"
        netstat -tulpn | grep :3389 || echo "ğŸ”´ RDP port nu este deschis"

    - name: âš™ï¸ Configure VM via VNC (auto-install)
      run: |
        echo "âš™ï¸ Configurare automatÄƒ via VNC..."
        python3 scripts/vnc-automation.py

    - name: ğŸ”„ Install Tailscale in VM
      run: |
        echo "ğŸ”— Instalare Tailscale..."
        # Folosim SMB sau SSH pentru a transfera È™i executa scriptul
        TAILSCALE_AUTH_KEY="${{ github.event.inputs.tailscale_auth_key }}" \
        VM_PASSWORD="${{ steps.generate_password.outputs.password }}" \
        python3 scripts/install-tailscale.py

    - name: ğŸ“‹ Display connection information
      run: |
        echo " "
        echo "ğŸ‰ WINDOWS SERVER 2025 RDP ESTE GATA!"
        echo "=========================================="
        echo "ğŸ–¥ï¸  SpecificaÈ›ii VM:"
        echo "   â€¢ RAM: ${{ env.VM_RAM }}"
        echo "   â€¢ SSD: ${{ env.VM_DISK }}"
        echo "   â€¢ CPU: AMD Ryzen 7 (8 cores emulate)"
        echo "   â€¢ GPU: QEMU virtual graphics"
        echo " "
        echo "ğŸ” Date de conectare:"
        echo "   â€¢ Utilizator: Administrator"
        echo "   â€¢ ParolÄƒ: ${{ steps.generate_password.outputs.password }}"
        echo "   â€¢ Tailscale Auth: ${{ github.event.inputs.tailscale_auth_key }}"
        echo " "
        echo "â° DuratÄƒ: ${{ github.event.inputs.run_duration }} zile"
        echo " "
        echo "ğŸŒ Pentru conectare:"
        echo "   1. InstaleazÄƒ Tailscale pe device-ul tÄƒu"
        echo "   2. ConecteazÄƒ-te cu auth key-ul de mai sus"
        echo "   3. FoloseÈ™te RDP cu IP-ul Tailscale"
        echo " "

    - name: â³ Keep VM running for specified duration
      run: |
        DAYS=${{ github.event.inputs.run_duration }}
        SECONDS=$((DAYS * 24 * 60 * 60))
        echo "â° VM va rula pentru $DAYS zile ($SECONDS secunde)..."
        
        # Counter pentru afiÈ™are progres
        for ((i=1; i<=SECONDS; i+=60)); do
          if (( i % 3600 == 0 )); then
            HOURS=$((i/3600))
            echo "â° VM ruleazÄƒ de $HOURS ore din $((DAYS*24)) ore..."
          fi
          sleep 60
        done

    - name: ğŸ§¹ Cleanup after duration
      if: always()
      run: |
        echo "ğŸ§¹ Oprire VM È™i cleanup..."
        pkill -f qemu-system-x86_64 || true
        rm -f windows2025.qcow2 win2025.iso
        echo "âœ… Cleanup complet!"
